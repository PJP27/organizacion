<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestor de Exámenes GitHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.js"></script>
    <style>
      .floating-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
      }

      .fc-event-time {
        display: none;
      }

      .fc-event-title-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .top-floating-button {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 100;
      }
      .hidden {
        display: none !important;
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 0.75rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
      #calendar {
        max-width: 900px;
        margin: 40px auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #weeklyCalendar {
        width: 100%;
        margin: 40px auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
        font-size: 34px;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen p-8">
    <!-- Botón flotante para abrir el gestor de exámenes -->
    <button
      onclick="toggleTaskManager()"
      class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded top-floating-button"
    >
      Añadir Examen
    </button>

    <!-- Modal para el gestor de exámenes -->
    <div id="taskManagerOverlay" class="overlay hidden"></div>
    <div id="taskManagerContainer" class="modal hidden">
      <div class="p-6">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">
          Gestor de Exámenes GitHub
        </h1>

        <!-- Formulario para ingresar credenciales -->
        <div id="credentialsForm">
          <input
            id="githubToken"
            type="password"
            autocomplete="current-password"
            class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Token Personal de GitHub"
          />
          <div class="flex space-x-2 mt-2">
            <button
              onclick="setCredentials()"
              class="flex-grow bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
            >
              Guardar Credenciales
            </button>
            <button
              onclick="closeTaskManager()"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors"
            >
              Cancelar
            </button>
          </div>
        </div>

        <!-- Formulario para añadir exámenes -->
        <div id="taskManager" class="hidden">
          <div class="mb-6">
            <label
              for="subjectSelect"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Asignatura:</label
            >
            <select
              id="subjectSelect"
              class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Selecciona una asignatura</option>
              <option value="Religion">Religión</option>
              <option value="Matematicas">Matemáticas</option>
              <option value="Fisica">Física</option>
              <option value="Lengua">Lengua</option>
              <option value="Historia">Historia</option>
              <option value="Filosofia">Filosofía</option>
              <option value="Tecnologia">Tecnología</option>
              <option value="Frances">Francés</option>
            </select>
          </div>
          <div class="mb-6">
            <label
              for="examInput"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Nombre del Examen:</label
            >
            <input
              id="examInput"
              type="text"
              class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Nombre del examen"
            />
          </div>
          <div class="mb-6">
            <label
              for="datePicker"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Fecha del Examen:</label
            >
            <input
              id="datePicker"
              type="text"
              class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Selecciona la fecha"
            />
          </div>
          <div class="flex space-x-2">
            <button
              onclick="addExam()"
              class="flex-grow bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
            >
              Añadir Examen
            </button>
            <button
              onclick="closeTaskManager()"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenedor del calendario mensual -->
    <div id="calendar"></div>

    <!-- Contenedor del calendario semanal -->
    <div id="weeklyCalendar"></div>

    <!-- Botón flotante para guardar cambios -->
    <button
      onclick="saveChanges()"
      class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded floating-button"
    >
      Guardar Cambios
    </button>

    <script>
      // Variables globales
      const REPO_OWNER = "PJP27";
      const REPO_NAME = "organizacion";
      let githubToken = "";
      const FILE_PATH = "data/exams.json";
      let exams = []; // Guardar los exámenes localmente
      let calendar; // Instancia del calendario mensual
      let weeklyCalendar; // Instancia del calendario semanal

      // Inicializar flatpickr
      flatpickr("#datePicker", {
        dateFormat: "Y-m-d",
      });

      // Función para alternar la visibilidad del gestor de exámenes
      function toggleTaskManager() {
        const taskManagerContainer = document.getElementById(
          "taskManagerContainer"
        );
        const taskManagerOverlay =
          document.getElementById("taskManagerOverlay");
        const credentialsForm = document.getElementById("credentialsForm");
        const taskManager = document.getElementById("taskManager");

        // Mostrar el contenedor y el overlay
        taskManagerContainer.classList.remove("hidden");
        taskManagerOverlay.classList.remove("hidden");

        // Mostrar el formulario de credenciales, ocultar el formulario de exámenes
        credentialsForm.classList.remove("hidden");
        taskManager.classList.add("hidden");
      }

      // Función para cerrar el gestor de exámenes
      function closeTaskManager() {
        const taskManagerContainer = document.getElementById(
          "taskManagerContainer"
        );
        const taskManagerOverlay =
          document.getElementById("taskManagerOverlay");
        taskManagerContainer.classList.add("hidden");
        taskManagerOverlay.classList.add("hidden");
      }

      // Función para guardar credenciales
      function setCredentials() {
        githubToken = document.getElementById("githubToken").value.trim();

        if (!githubToken) {
          alert("Por favor, ingresa un token válido.");
          return;
        }

        // Ocultar formulario de credenciales y mostrar el gestor de tareas
        document.getElementById("credentialsForm").classList.add("hidden");
        document.getElementById("taskManager").classList.remove("hidden");

        // Cargar los exámenes existentes
        loadAndRenderExams();
      }

      // Función para añadir un examen
      function addExam() {
        const subject = document.getElementById("subjectSelect").value;
        const examName = document.getElementById("examInput").value.trim();
        const examDate = document.getElementById("datePicker").value;

        if (!subject || !examName || !examDate) {
          alert(
            "Por favor, selecciona una asignatura, ingresa el nombre del examen y la fecha."
          );
          return;
        }

        const newExam = {
          id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          subject: subject,
          examName: examName,
          examDate: examDate,
          created: new Date().toISOString(), // Add creation timestamp
        };

        exams.push(newExam);
        renderCalendar(exams); // Actualizar el calendario mensual
        renderWeeklyCalendar(exams); // Actualizar el calendario semanal

        // Limpiar los campos
        document.getElementById("subjectSelect").value = "";
        document.getElementById("examInput").value = "";
        document.getElementById("datePicker").value = "";
      }

      // Función para guardar cambios en GitHub
      async function saveChanges() {
        try {
          // Ensure all exams have an ID and created timestamp
          const processedExams = exams.map((exam) => ({
            ...exam,
            id:
              exam.id ||
              `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            created: exam.created || new Date().toISOString(),
          }));

          const success = await retryExamSave(processedExams, 3);

          if (success) {
            alert("¡Cambios guardados exitosamente en GitHub!");
          }
        } catch (error) {
          console.error("Error al guardar cambios:", error);
          alert(`No se pudieron guardar los cambios: ${error.message}`);
        }
      }

      // Función de reintento para guardar exámenes
      async function retryExamSave(examsToSave, maxRetries) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            const currentSHA = await getFileSHA();
            const content = btoa(
              unescape(encodeURIComponent(JSON.stringify(examsToSave)))
            );

            const response = await fetch(
              `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
              {
                method: "PUT",
                headers: {
                  Authorization: `token ${githubToken}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  message: `Update exams (Attempt ${attempt})`,
                  content,
                  sha: currentSHA,
                }),
              }
            );

            if (response.ok) {
              console.log("Exámenes guardados exitosamente en GitHub.");
              await loadAndRenderExams();
              return true;
            }

            const errorData = await response.json();

            if (response.status === 409) {
              console.warn(
                `Conflicto en el intento ${attempt}. Refrescando exámenes...`
              );
              const latestExams = await loadExams();
              exams = mergeExams(latestExams, examsToSave);

              if (attempt === maxRetries) {
                throw new Error(
                  "No se pudo resolver el conflicto después de varios intentos"
                );
              }

              await new Promise((resolve) =>
                setTimeout(resolve, 1000 * attempt)
              );
            } else {
              throw new Error(`Error al guardar: ${errorData.message}`);
            }
          } catch (error) {
            console.error(`Intento ${attempt} fallido:`, error);

            if (attempt === maxRetries) {
              throw error;
            }

            await new Promise((resolve) => setTimeout(resolve, 1000 * attempt));
          }
        }

        return false;
      }

      // Función para fusionar exámenes locales y remotos
      function mergeExams(remoteExams, localExams) {
        const examMap = new Map();

        // Primero añadir todos los exámenes remotos
        remoteExams.forEach((exam) => {
          examMap.set(
            exam.id ||
              `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            exam
          );
        });

        // Luego añadir o actualizar con exámenes locales
        localExams.forEach((localExam) => {
          const existingExam = examMap.get(localExam.id);

          if (
            !existingExam ||
            new Date(localExam.created) > new Date(existingExam.created)
          ) {
            examMap.set(localExam.id, localExam);
          }
        });

        return Array.from(examMap.values()).sort(
          (a, b) => new Date(a.created) - new Date(b.created)
        );
      }

      // Cargar exámenes desde GitHub
      async function loadExams() {
        try {
          const response = await fetch(
            `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${FILE_PATH}?t=${Date.now()}`
          );

          if (!response.ok) {
            if (response.status === 404) return [];
            throw new Error(
              `Error al cargar los exámenes: ${response.status} - ${response.statusText}`
            );
          }

          const loadedExams = await response.json();

          // Ensure each exam has an ID and created timestamp
          const processedExams = loadedExams.map((exam) => ({
            ...exam,
            id:
              exam.id ||
              `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            created: exam.created || new Date().toISOString(),
          }));

          exams = processedExams; // Update global exams
          return processedExams;
        } catch (error) {
          console.error("Error al cargar exámenes:", error);
          throw error;
        }
      }

      // Obtener SHA del archivo desde GitHub
      async function getFileSHA() {
        try {
          const response = await fetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
            { headers: { Authorization: `token ${githubToken}` } }
          );

          if (!response.ok) throw new Error(`Error al obtener SHA del archivo`);
          return (await response.json()).sha;
        } catch (error) {
          console.error("Error SHA");
        }
      }

      // Renderizar exámenes en el calendario mensual
      function renderCalendar(exams) {
        if (!calendar) {
          // Inicializar el calendario solo una vez
          const calendarEl = document.getElementById("calendar");
          calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            locale: "es",
            firstDay: 1,
            headerToolbar: {
              left: "prev,next",
              center: "title",
              right: "",
            },
            // Mostrar siempre el mes actual y el siguiente
            visibleRange: function (currentDate) {
              const start = new Date(
                currentDate.getFullYear(),
                currentDate.getMonth(),
                1
              );
              const end = new Date(
                currentDate.getFullYear(),
                currentDate.getMonth() + 2,
                0
              );
              return { start: start, end: end };
            },
            events: exams.map((exam) => {
              return {
                title: `${exam.subject}: ${exam.examName}`,
                start: exam.examDate,
                end: exam.examDate,
                allDay: true,
              };
            }),
          });
          calendar.render();
        } else {
          // Si el calendario ya está inicializado, actualizar los eventos
          calendar.getEvents().forEach((event) => event.remove());

          exams.forEach((exam) => {
            calendar.addEvent({
              title: `${exam.subject}: ${exam.examName}`,
              start: exam.examDate,
              end: exam.examDate,
              allDay: true,
            });
          });
        }
      }

      // Renderizar el calendario semanal

      function renderWeeklyCalendar(exams) {
        const weeklyCalendarEl = document.getElementById("weeklyCalendar");

        if (!weeklyCalendar) {
          weeklyCalendar = new FullCalendar.Calendar(weeklyCalendarEl, {
            initialView: "timeGridWeek",
            locale: "es",
            firstDay: 1,
            headerToolbar: {
              left: "prev,next",
              center: "title",
              right: "",
            },
            slotMinTime: "08:15:00",
            slotMaxTime: "15:15:00",
            allDaySlot: false,
            slotLabelFormat: {
              hour: "numeric",
              minute: "2-digit",
              omitZeroMinute: false,
              meridiem: false,
            },
            slotLabelContent: function (info) {
              const labels = [
                "1era",
                "2da",
                "3era",
                "Recreo",
                "4ta",
                "5ta",
                "6ta",
              ];
              return (
                labels[
                  Math.floor(
                    info.date.getHours() - 8 + info.date.getMinutes() / 60
                  )
                ] || ""
              );
            },
            eventContent: function (arg) {
              const allEvents = arg.view.calendar.getEvents();
              const eventsAtSameTime = allEvents.filter(
                (event) =>
                  event.start.getTime() === arg.event.start.getTime() &&
                  event.end.getTime() === arg.event.end.getTime()
              );

              if (eventsAtSameTime.length > 1) {
                // Aquí identificamos el segundo evento (el de z-index 2)
                const secondEvent = eventsAtSameTime[1];

                // Si encontramos el segundo evento, cambiamos su z-index a -9999
                if (secondEvent) {
                  const eventElement = secondEvent.el;
                  eventElement.style.zIndex = -9999;
                }

                // Retornar el primer evento para que se quede visible
                const regularEvent = eventsAtSameTime.find(
                  (ev) => !ev.extendedProps.isExam
                );

                return {
                  html: `<div style="display: flex; flex-direction: column; height: 100%;">
                      <div style="flex: 1; padding: 2px; font-size: 0.8em; overflow: hidden; text-overflow: ellipsis;">
   
