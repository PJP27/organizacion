<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas GitHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .task-item { transition: all 0.3s; }
        .task-item:hover { transform: translateX(5px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">Gestor de Tareas GitHub</h1>

        <!-- Formulario para ingresar credenciales -->
        <div id="credentialsForm" class="mb-6">
            <input id="githubToken" type="password" autocomplete="current-password"
                   class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Token Personal de GitHub">
            <button onclick="setCredentials()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg mt-2 w-full transition-colors">
                Guardar Credenciales
            </button>
        </div>

        <!-- Formulario para añadir tareas -->
        <div id="taskManager" style="display: none;">
            <div class="flex gap-2 mb-6">
                <input id="taskInput" type="text" 
                       class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Nueva tarea">
                <button onclick="addTask()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    Añadir Tarea
                </button>
            </div>
            <div id="taskList" class="space-y-2"></div>
        </div>
    </div>

<script>
// Variables globales
const REPO_OWNER = 'PJP27';
const REPO_NAME = 'organizacion';
let githubToken = '';
const FILE_PATH = 'data/tasks.json';

// Función para guardar credenciales
function setCredentials() {
    githubToken = document.getElementById('githubToken').value.trim();

    if (!githubToken) {
        alert('Por favor, ingresa un token válido.');
        return;
    }

    // Ocultar formulario de credenciales y mostrar el gestor de tareas
    document.getElementById('credentialsForm').style.display = 'none';
    document.getElementById('taskManager').style.display = 'block';

    // Cargar las tareas existentes
    loadAndRenderTasks();
}

// Función para añadir una tarea
async function addTask() {
    const input = document.getElementById('taskInput');
    const taskText = input.value.trim();

    if (!taskText) return;

    try {
        let tasks = await loadTasks();
        tasks.push({
            id: Date.now(),
            text: taskText,
            completed: false,
            created: new Date().toISOString()
        });

        await saveTasks(tasks);
        input.value = '';
        renderTasks(tasks);
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// Guardar tareas en GitHub con manejo de conflictos
async function saveTasks(tasks) {
    const content = btoa(JSON.stringify(tasks));
    const message = `Actualización de tareas: ${new Date().toLocaleString()}`;
    let sha;

    try {
        sha = await getFileSHA();

        const response = await fetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
            {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message,
                    content,
                    sha
                })
            }
        );

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Error al guardar en GitHub: ${response.status} - ${errorData.message}`);
        }
    } catch (error) {
        console.error('Error al guardar tareas:', error);

        // Manejar conflictos (409 Conflict)
        if (error.message.includes("409")) {
            console.warn("Conflicto detectado. Resolviendo y guardando...");
            
            try {
                // Obtener el SHA más reciente y el contenido actual del archivo
                sha = await getFileSHA();
                const currentTasks = await loadTasks();

                // Fusionar las tareas locales y remotas
                const mergedTasks = mergeTasks(currentTasks, tasks);
                const mergedContent = btoa(JSON.stringify(mergedTasks));

                const response = await fetch(
                    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message,
                            content: mergedContent,
                            sha
                        })
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error al guardar tras la fusión: ${response.status} - ${errorData.message}`);
                }

                console.log("Conflicto resuelto y cambios guardados.");
                return; // Importante: Terminar la función aquí para evitar bucles infinitos
            } catch (mergeError) {
                console.error("Error al fusionar y guardar:", mergeError);
                alert("Error al fusionar y guardar los cambios.");
                return;
            }
        } else {
            throw error;
        }
    }
}

// Función para fusionar tareas locales y remotas
function mergeTasks(remoteTasks, localTasks) {
    const merged = [...remoteTasks];

    localTasks.forEach(localTask => {
        if (!remoteTasks.some(remoteTask => remoteTask.id === localTask.id)) {
            merged.push(localTask);
        }
    });

    return merged;
}

// Cargar tareas desde GitHub
async function loadTasks() {
    try {
        const response = await fetch(
            `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${FILE_PATH}`
        );

        if (!response.ok) {
            if (response.status === 404) {
                return [];
            } else {
                throw new Error(`Error al cargar las tareas: ${response.status} - ${response.statusText}`);
            }
        }

        return await response.json();
    } catch (error) {
        console.error('Error al cargar tareas:', error);
        throw error;
    }
}

// Obtener SHA del archivo
async function getFileSHA() {
    try {
        const response = await fetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
            { headers: { 'Authorization': `token ${githubToken}` } }
        );

        if (!response.ok) {
            throw new Error(`Error al obtener el SHA del archivo: ${response.status} - ${response.statusText}`);
        }

        const data = await response.json();
        return data.sha;
    } catch (error) {
        console.error('Error al obtener el SHA del archivo:', error);
        throw error;
    }
}

// Renderizar tareas en la interfaz
function renderTasks(tasks) {
    const container = document.getElementById('taskList');
    container.innerHTML = tasks.map(task => `
        <div class="task-item flex items-center justify-between bg-gray-50 p-3 rounded-lg">
            <span>${task.text}</span>
            <button onclick="deleteTask(${task.id})" 
                    class="text-red-500 hover:text-red-600 ml-2">✕</button>
        </div>
    `).join('');
}

// Eliminar una tarea específica
async function deleteTask(taskId) {
    try {
        let tasks = await loadTasks();
        const filteredTasks = tasks.filter(task => task.id !== taskId);

        await saveTasks(filteredTasks);
        renderTasks(filteredTasks);
    } catch (error) {
        console.error('Error al eliminar la tarea:', error);
        alert('Error al eliminar la tarea.');
    }
}

// Cargar y renderizar tareas
async function loadAndRenderTasks() {
    try {
        const tasks = await loadTasks();
        renderTasks(tasks);
    } catch (error) {
        console.error('Error al cargar las tareas:', error);
        alert('No se pudo cargar las tareas.');
    }
}
</script>

</body>
</html>
